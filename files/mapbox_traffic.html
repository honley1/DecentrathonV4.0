<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Mapbox Traffic Visualization</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />


    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #menu {
            background: #fff;
            position: absolute;
            z-index: 1;
            top: 10px;
            right: 10px;
            border-radius: 3px;
            width: 120px;
            border: 1px solid rgba(0,0,0,0.4);
            font-family: 'Open Sans', sans-serif;
        }
        #menu a {
            font-size: 13px;
            color: #404040;
            display: block;
            margin: 0;
            padding: 10px;
            text-decoration: none;
            border-bottom: 1px solid rgba(0,0,0,0.25);
            text-align: center;
        }
        #menu a:last-child {
            border: none;
        }
        #menu a:hover {
            background-color: #f8f8f8;
            color: #404040;
        }
        #menu a.active {
            background-color: #3887be;
            color: #ffffff;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            max-width: 300px;
            z-index: 1;
        }
    </style>
</head>
<body>

<div id='map'></div>
<nav id='menu'>
    <a href='#' class='active' onclick='toggleTraffic()'>Hide Traffic</a>
</nav>

<div class='info-panel'>
    <h3>Сгруппированные дорожные линии</h3>
    <p>Непрерывные линии дорог с ультра-чувствительной градацией.</p>
    <p><strong style="color: #00C851;">━</strong> <strong>Ярко-зелёный:</strong> Свободно (<0.4)</p>
    <p><strong style="color: #7CB342;">━</strong> <strong>Светло-зелёный:</strong> Очень хорошо (0.4-0.5)</p>
    <p><strong style="color: #8BC34A;">━</strong> <strong>Зелёный:</strong> Хорошо (0.5-0.57)</p>
    <p><strong style="color: #CDDC39;">━</strong> <strong>Лайм:</strong> Выше 25% (0.57-0.65)</p>
    <p><strong style="color: #FFEB3B;">━</strong> <strong>Жёлто-зелёный:</strong> Ниже медианы (0.65-0.7)</p>
    <p><strong style="color: #FFC107;">━</strong> <strong>Жёлтый:</strong> Около медианы (0.7-0.74)</p>
    <p><strong style="color: #FF9800;">━</strong> <strong>Жёлто-оранжевый:</strong> Выше медианы (0.74-0.8)</p>
    <p><strong style="color: #FF5722;">━</strong> <strong>Оранжевый:</strong> Значительные заторы (0.8-0.85)</p>
    <p><strong style="color: #F44336;">━</strong> <strong>Красно-оранжевый:</strong> Тяжёлые заторы (0.85-0.91)</p>
    <p><strong style="color: #E53935;">━</strong> <strong>Красный:</strong> Выше 75% (0.91-0.95)</p>
    <p><strong style="color: #C62828;">━</strong> <strong>Тёмно-красный:</strong> Экстремальные пробки (0.95+)</p>
    <p><small>Толщина линий зависит от интенсивности трафика</small></p>
</div>

<script>
// Add your Mapbox access token here
// You need to get this from https://account.mapbox.com/
mapboxgl.accessToken = 'pk.eyJ1IjoibWlsYW4xMzM3IiwiYSI6ImNtZmliNGw1NjBqMHUya3F3N2ZlYmI4dGkifQ.1wSnZEu14y4snJroP8xOYA';

// Initialize the map
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11', // You can change this to other styles
    center: [71.414, 51.086719], // Astana coordinates
    zoom: 14
});

// Traffic visibility state
let trafficVisible = true;

map.on('load', function () {
    // Load CSV data and create traffic visualization
    fetch('/files/grid_data.csv')
        .then(response => response.text())
        .then(data => {
            const lines = data.split('\n');
            const gridData = new Map();
            const features = [];

            // First pass: organize data by grid coordinates for proper grouping
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const [cell_id, lat_center, lng_center, lat_min, lat_max, lng_min, lng_max, point_density, avg_speed, traffic_load] = line.split(',');

                if (lat_min && lat_max && lng_min && lng_max && traffic_load) {
                    const load = parseFloat(traffic_load);
                    const speed = parseFloat(avg_speed);
                    const centerLat = parseFloat(lat_center);
                    const centerLng = parseFloat(lng_center);

                    // Extract grid coordinates from cell_id
                    const [row, col] = cell_id.split('_').map(n => parseInt(n));

                    // High sensitivity color mapping based on traffic_load statistics
                    let intensity = 0;
                    if (load >= 0.95) {
                        intensity = 1.0; // Dark Red - Extreme jam (top 5%)
                    } else if (load >= 0.91) {
                        intensity = 0.9; // Red - Severe jam (75th percentile+)
                    } else if (load >= 0.85) {
                        intensity = 0.8; // Orange Red - Heavy jam
                    } else if (load >= 0.80) {
                        intensity = 0.7; // Orange - Significant jam
                    } else if (load >= 0.74) {
                        intensity = 0.6; // Yellow Orange - Above median
                    } else if (load >= 0.70) {
                        intensity = 0.5; // Yellow - Around median
                    } else if (load >= 0.65) {
                        intensity = 0.4; // Yellow Green - Below median
                    } else if (load >= 0.57) {
                        intensity = 0.3; // Light Green - Above 25th percentile
                    } else if (load >= 0.50) {
                        intensity = 0.2; // Green - Good flow
                    } else if (load >= 0.40) {
                        intensity = 0.1; // Bright Green - Very good flow
                    } else {
                        intensity = 0.0; // Dark Green - Free flow (below 0.4)
                    }

                    gridData.set(`${row}_${col}`, {
                        lat: centerLat,
                        lng: centerLng,
                        intensity: intensity,
                        load: load,
                        speed: speed,
                        cell_id: cell_id,
                        point_density: parseFloat(point_density) || 0,
                        row: row,
                        col: col
                    });
                }
            }

            // Second pass: create continuous road line segments
            const processedCells = new Set();

            for (const [key, cell] of gridData.entries()) {
                const { row, col, lat, lng, intensity, load, speed, cell_id, point_density } = cell;

                // Create horizontal road segments (west to east)
                if (!processedCells.has(`h_${row}_${col}`)) {
                    const horizontalLine = [[lng, lat]];
                    let currentCol = col;
                    let totalIntensity = intensity;
                    let totalLoad = load;
                    let totalSpeed = speed;
                    let segmentCount = 1;
                    let cellIds = [cell_id];

                    // Extend horizontally to the right
                    while (gridData.has(`${row}_${currentCol + 1}`)) {
                        currentCol++;
                        const nextCell = gridData.get(`${row}_${currentCol}`);
                        horizontalLine.push([nextCell.lng, nextCell.lat]);
                        totalIntensity += nextCell.intensity;
                        totalLoad += nextCell.load;
                        totalSpeed += nextCell.speed;
                        segmentCount++;
                        cellIds.push(nextCell.cell_id);
                        processedCells.add(`h_${row}_${currentCol}`);
                    }

                    // Create line segment if it has multiple points
                    if (horizontalLine.length > 1) {
                        features.push({
                            type: 'Feature',
                            properties: {
                                intensity: totalIntensity / segmentCount,
                                traffic_load: totalLoad / segmentCount,
                                avg_speed: totalSpeed / segmentCount,
                                cell_id: `horizontal_${row}_${col}-${currentCol}`,
                                point_density: point_density,
                                line_type: 'horizontal',
                                segment_length: horizontalLine.length,
                                cells_included: cellIds.join(', ')
                            },
                            geometry: {
                                type: 'LineString',
                                coordinates: horizontalLine
                            }
                        });
                    }
                    processedCells.add(`h_${row}_${col}`);
                }

                // Create vertical road segments (north to south)
                if (!processedCells.has(`v_${row}_${col}`)) {
                    const verticalLine = [[lng, lat]];
                    let currentRow = row;
                    let totalIntensity = intensity;
                    let totalLoad = load;
                    let totalSpeed = speed;
                    let segmentCount = 1;
                    let cellIds = [cell_id];

                    // Extend vertically downward
                    while (gridData.has(`${currentRow + 1}_${col}`)) {
                        currentRow++;
                        const nextCell = gridData.get(`${currentRow}_${col}`);
                        verticalLine.push([nextCell.lng, nextCell.lat]);
                        totalIntensity += nextCell.intensity;
                        totalLoad += nextCell.load;
                        totalSpeed += nextCell.speed;
                        segmentCount++;
                        cellIds.push(nextCell.cell_id);
                        processedCells.add(`v_${currentRow}_${col}`);
                    }

                    // Create line segment if it has multiple points
                    if (verticalLine.length > 1) {
                        features.push({
                            type: 'Feature',
                            properties: {
                                intensity: totalIntensity / segmentCount,
                                traffic_load: totalLoad / segmentCount,
                                avg_speed: totalSpeed / segmentCount,
                                cell_id: `vertical_${row}-${currentRow}_${col}`,
                                point_density: point_density,
                                line_type: 'vertical',
                                segment_length: verticalLine.length,
                                cells_included: cellIds.join(', ')
                            },
                            geometry: {
                                type: 'LineString',
                                coordinates: verticalLine
                            }
                        });
                    }
                    processedCells.add(`v_${row}_${col}`);
                }
            }

            console.log(`Created ${features.length} traffic squares from CSV data`);

            // Add traffic source with CSV data
            map.addSource('traffic', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': features
                }
            });

            // Add traffic layer as grouped road line segments
            map.addLayer({
                'id': 'traffic',
                'type': 'line',
                'source': 'traffic',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round',
                    'visibility': 'visible'
                },
                'paint': {
                    'line-width': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        8, ['*', 1.5, ['+', 1, ['*', 0.5, ['get', 'intensity']]]],   // 1.5-3px at zoom 8
                        12, ['*', 2, ['+', 1, ['*', 1, ['get', 'intensity']]]],      // 2-4px at zoom 12
                        16, ['*', 3, ['+', 1, ['*', 1.5, ['get', 'intensity']]]],   // 3-7.5px at zoom 16
                        20, ['*', 4, ['+', 1, ['*', 2, ['get', 'intensity']]]]      // 4-12px at zoom 20
                    ],
                    'line-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'intensity'],
                        0.0, '#00C851',    // Bright Green - Free flow (load < 0.4)
                        0.1, '#7CB342',    // Light Green - Very good (0.4-0.5)
                        0.2, '#8BC34A',    // Green - Good flow (0.5-0.57)
                        0.3, '#CDDC39',    // Light Green - Above 25th percentile (0.57-0.65)
                        0.4, '#FFEB3B',    // Yellow Green - Below median (0.65-0.7)
                        0.5, '#FFC107',    // Yellow - Around median (0.7-0.74)
                        0.6, '#FF9800',    // Yellow Orange - Above median (0.74-0.8)
                        0.7, '#FF5722',    // Orange - Significant (0.8-0.85)
                        0.8, '#F44336',    // Orange Red - Heavy (0.85-0.91)
                        0.9, '#E53935',    // Red - Severe (0.91-0.95)
                        1.0, '#C62828'     // Dark Red - Extreme (0.95+)
                    ],
                    'line-opacity': 0.9
                }
            });

            console.log(`Loaded ${features.length} traffic data points`);
        })
        .catch(error => {
            console.error('Error loading CSV data:', error);
            // Fallback to Mapbox traffic data
            map.addSource('traffic', {
                'type': 'vector',
                'url': 'mapbox://mapbox.mapbox-traffic-v1'
            });

            map.addLayer({
                'id': 'traffic',
                'type': 'line',
                'source': 'traffic',
                'source-layer': 'traffic',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round',
                    'visibility': 'visible'
                },
                'paint': {
                    'line-width': [
                        'case',
                        ['==', ['get', 'congestion'], 'low'], 4,
                        ['==', ['get', 'congestion'], 'moderate'], 6,
                        ['==', ['get', 'congestion'], 'heavy'], 8,
                        ['==', ['get', 'congestion'], 'severe'], 10,
                        4
                    ],
                    'line-color': [
                        'case',
                        ['==', ['get', 'congestion'], 'low'],
                        '#22c55e',
                        ['==', ['get', 'congestion'], 'moderate'],
                        '#eab308',
                        ['==', ['get', 'congestion'], 'heavy'],
                        '#ef4444',
                        ['==', ['get', 'congestion'], 'severe'],
                        '#dc2626',
                        '#22c55e'
                    ],
                    'line-opacity': 0.8
                }
            });
        });

    // Add navigation control
    map.addControl(new mapboxgl.NavigationControl());

    // Add fullscreen control
    map.addControl(new mapboxgl.FullscreenControl());

    // Add geolocate control to find user's location
    map.addControl(
        new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true
        })
    );

    console.log('Map loaded with traffic data');
});

// Function to toggle traffic
function toggleTraffic() {
    trafficVisible = !trafficVisible;

    // Toggle traffic layer
    if (map.getLayer('traffic')) {
        map.setLayoutProperty(
            'traffic',
            'visibility',
            trafficVisible ? 'visible' : 'none'
        );
    }

    // Update button text
    const button = document.querySelector('#menu a');
    button.textContent = trafficVisible ? 'Hide Traffic' : 'Show Traffic';
}

// Add click event to get traffic data at clicked location
map.on('click', 'traffic', function(e) {
    const properties = e.features[0].properties;
    const coordinates = e.lngLat;

    // Convert intensity to percentage and traffic level description
    const intensityPercent = (properties.intensity * 100).toFixed(0);
    let trafficLevel = '';
    let colorCode = '';

    if (properties.intensity >= 1.0) {
        trafficLevel = 'Экстремальные пробки (0.95+)';
        colorCode = '#C62828';
    } else if (properties.intensity >= 0.9) {
        trafficLevel = 'Выше 75% (0.91-0.95)';
        colorCode = '#E53935';
    } else if (properties.intensity >= 0.8) {
        trafficLevel = 'Тяжёлые заторы (0.85-0.91)';
        colorCode = '#F44336';
    } else if (properties.intensity >= 0.7) {
        trafficLevel = 'Значительные заторы (0.8-0.85)';
        colorCode = '#FF5722';
    } else if (properties.intensity >= 0.6) {
        trafficLevel = 'Выше медианы (0.74-0.8)';
        colorCode = '#FF9800';
    } else if (properties.intensity >= 0.5) {
        trafficLevel = 'Около медианы (0.7-0.74)';
        colorCode = '#FFC107';
    } else if (properties.intensity >= 0.4) {
        trafficLevel = 'Ниже медианы (0.65-0.7)';
        colorCode = '#FFEB3B';
    } else if (properties.intensity >= 0.3) {
        trafficLevel = 'Выше 25% (0.57-0.65)';
        colorCode = '#CDDC39';
    } else if (properties.intensity >= 0.2) {
        trafficLevel = 'Хорошо (0.5-0.57)';
        colorCode = '#8BC34A';
    } else if (properties.intensity >= 0.1) {
        trafficLevel = 'Очень хорошо (0.4-0.5)';
        colorCode = '#7CB342';
    } else {
        trafficLevel = 'Свободно (<0.4)';
        colorCode = '#00C851';
    }

    new mapboxgl.Popup()
        .setLngLat(coordinates)
        .setHTML(`
            <h3>Дорожный сегмент</h3>
            <p><strong>Сегмент:</strong> ${properties.cell_id}</p>
            <p><strong>Тип линии:</strong> ${properties.line_type === 'horizontal' ? 'Горизонтальная' : 'Вертикальная'}</p>
            <p><strong>Длина сегмента:</strong> ${properties.segment_length} точек</p>
            <p><strong>Средняя загруженность:</strong> ${properties.traffic_load.toFixed(3)}</p>
            <p><strong>Средняя скорость:</strong> ${properties.avg_speed.toFixed(1)} км/ч</p>
            <p><strong>Уровень трафика:</strong> <span style="color: ${colorCode}; font-size: 16px;">━</span> ${trafficLevel}</p>
            <p><strong>Интенсивность:</strong> ${intensityPercent}%</p>
            <p><strong>Включённые ячейки:</strong><br><small>${properties.cells_included}</small></p>
            <p><strong>Координаты:</strong><br>
            Lat: ${coordinates.lat.toFixed(6)}<br>
            Lng: ${coordinates.lng.toFixed(6)}</p>
        `)
        .addTo(map);
});

// Change cursor on hover
map.on('mouseenter', 'traffic', function() {
    map.getCanvas().style.cursor = 'pointer';
});

map.on('mouseleave', 'traffic', function() {
    map.getCanvas().style.cursor = '';
});

// Handle map errors
map.on('error', function(e) {
    console.error('Map error:', e);
    alert('Map loading error. Please check your Mapbox access token.');
});
</script>

</body>
</html>