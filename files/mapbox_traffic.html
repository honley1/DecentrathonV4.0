<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Mapbox Traffic Visualization</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />


    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #menu {
            background: #fff;
            position: absolute;
            z-index: 1;
            top: 10px;
            right: 10px;
            border-radius: 3px;
            width: 120px;
            border: 1px solid rgba(0,0,0,0.4);
            font-family: 'Open Sans', sans-serif;
        }
        #menu a {
            font-size: 13px;
            color: #404040;
            display: block;
            margin: 0;
            padding: 10px;
            text-decoration: none;
            border-bottom: 1px solid rgba(0,0,0,0.25);
            text-align: center;
        }
        #menu a:last-child {
            border: none;
        }
        #menu a:hover {
            background-color: #f8f8f8;
            color: #404040;
        }
        #menu a.active {
            background-color: #3887be;
            color: #ffffff;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            max-width: 300px;
            z-index: 1;
        }
    </style>
</head>
<body>

<div id='map'></div>
<nav id='menu'>
    <a href='#' class='active' onclick='toggleTraffic()'>Hide Traffic</a>
</nav>

<div class='info-panel'>
    <h3>Плавная карта трафика</h3>
    <p>Заполненные квадраты с ультра-плавной градацией (21 цвет).</p>
    <p><strong style="color: #004d00;">■</strong> <strong>Очень тёмно-зелёный:</strong> Минимум (0.0)</p>
    <p><strong style="color: #008800;">■</strong> <strong>Лесной зелёный:</strong> Низкий (0.1)</p>
    <p><strong style="color: #00ff00;">■</strong> <strong>Ярко-зелёный:</strong> Хороший (0.25)</p>
    <p><strong style="color: #66ff66;">■</strong> <strong>Бледно-зелёный:</strong> Умеренный (0.35)</p>
    <p><strong style="color: #ccffcc;">■</strong> <strong>Мятный:</strong> Средний (0.45)</p>
    <p><strong style="color: #ffff99;">■</strong> <strong>Жёлто-зелёный:</strong> Повышенный (0.5)</p>
    <p><strong style="color: #ffff00;">■</strong> <strong>Жёлтый:</strong> Заметный (0.65)</p>
    <p><strong style="color: #ffcc00;">■</strong> <strong>Золотой:</strong> Высокий (0.7)</p>
    <p><strong style="color: #ff9900;">■</strong> <strong>Оранжево-жёлтый:</strong> Серьёзный (0.75)</p>
    <p><strong style="color: #ff6600;">■</strong> <strong>Оранжевый:</strong> Тяжёлый (0.8)</p>
    <p><strong style="color: #ff3300;">■</strong> <strong>Красно-оранжевый:</strong> Критический (0.85)</p>
    <p><strong style="color: #ff0000;">■</strong> <strong>Красный:</strong> Пробка (0.9)</p>
    <p><strong style="color: #990000;">■</strong> <strong>Тёмно-красный:</strong> Максимум (1.0)</p>
    <p><small>Плавные переходы между всеми 21 цветом спектра</small></p>
</div>

<script>
// Add your Mapbox access token here
// You need to get this from https://account.mapbox.com/
mapboxgl.accessToken = 'pk.eyJ1IjoibWlsYW4xMzM3IiwiYSI6ImNtZmliNGw1NjBqMHUya3F3N2ZlYmI4dGkifQ.1wSnZEu14y4snJroP8xOYA';

// Initialize the map
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11', // You can change this to other styles
    center: [71.414, 51.086719], // Astana coordinates
    zoom: 14
});

// Traffic visibility state
let trafficVisible = true;

map.on('load', function () {
    // Load CSV data and create traffic visualization
    fetch('/files/grid_data.csv')
        .then(response => response.text())
        .then(data => {
            const lines = data.split('\n');
            const gridData = new Map();
            const features = [];

            // Create filled squares using exact corner coordinates from CSV
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const [cell_id, lat_center, lng_center, lat_min, lat_max, lng_min, lng_max, point_density, avg_speed, traffic_load] = line.split(',');

                if (lat_min && lat_max && lng_min && lng_max && traffic_load) {
                    const load = parseFloat(traffic_load);
                    const speed = parseFloat(avg_speed);
                    const latMin = parseFloat(lat_min);
                    const latMax = parseFloat(lat_max);
                    const lngMin = parseFloat(lng_min);
                    const lngMax = parseFloat(lng_max);

                    // Ultra-smooth intensity mapping for maximum color gradation
                    // Normalize traffic_load from 0-1 range to get smooth transitions
                    const intensity = Math.min(1.0, Math.max(0.0, load));

                    // Create filled polygon using corner coordinates with slight overlap
                    const overlap = 0.000005; // Very small overlap to eliminate gaps
                    const smoothLngMin = lngMin - overlap;
                    const smoothLngMax = lngMax + overlap;
                    const smoothLatMin = latMin - overlap;
                    const smoothLatMax = latMax + overlap;

                    features.push({
                        type: 'Feature',
                        properties: {
                            intensity: intensity,
                            traffic_load: load,
                            avg_speed: speed,
                            cell_id: cell_id,
                            point_density: parseFloat(point_density) || 0
                        },
                        geometry: {
                            type: 'Polygon',
                            coordinates: [[
                                [smoothLngMin, smoothLatMin], // Bottom-left
                                [smoothLngMax, smoothLatMin], // Bottom-right
                                [smoothLngMax, smoothLatMax], // Top-right
                                [smoothLngMin, smoothLatMax], // Top-left
                                [smoothLngMin, smoothLatMin]  // Close polygon
                            ]]
                        }
                    });
                }
            }

            console.log(`Created ${features.length} smooth filled squares with 21-color spectrum`);

            // Add traffic source with CSV data
            map.addSource('traffic', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': features
                }
            });

            // Add traffic layer as smooth filled squares with ultra-large color spectrum
            map.addLayer({
                'id': 'traffic',
                'type': 'fill',
                'source': 'traffic',
                'layout': {
                    'visibility': 'visible'
                },
                'paint': {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'intensity'],
                        0.00, '#004d00',  // Very Dark Green
                        0.05, '#006600',  // Dark Green
                        0.10, '#008800',  // Forest Green
                        0.15, '#00aa00',  // Green
                        0.20, '#00cc00',  // Bright Green
                        0.25, '#00ff00',  // Pure Green
                        0.30, '#33ff33',  // Light Green
                        0.35, '#66ff66',  // Pale Green
                        0.40, '#99ff99',  // Very Light Green
                        0.45, '#ccffcc',  // Mint Green
                        0.50, '#ffff99',  // Light Yellow Green
                        0.55, '#ffff66',  // Yellow Green
                        0.60, '#ffff33',  // Yellow
                        0.65, '#ffff00',  // Pure Yellow
                        0.70, '#ffcc00',  // Golden Yellow
                        0.75, '#ff9900',  // Orange Yellow
                        0.80, '#ff6600',  // Orange
                        0.85, '#ff3300',  // Red Orange
                        0.90, '#ff0000',  // Red
                        0.95, '#cc0000',  // Dark Red
                        1.00, '#990000'   // Very Dark Red
                    ],
                    'fill-opacity': 0.8,
                    'fill-outline-color': 'transparent'
                }
            });

            console.log(`Loaded ${features.length} traffic data points`);
        })
        .catch(error => {
            console.error('Error loading CSV data:', error);
            // Fallback to Mapbox traffic data
            map.addSource('traffic', {
                'type': 'vector',
                'url': 'mapbox://mapbox.mapbox-traffic-v1'
            });

            map.addLayer({
                'id': 'traffic',
                'type': 'line',
                'source': 'traffic',
                'source-layer': 'traffic',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round',
                    'visibility': 'visible'
                },
                'paint': {
                    'line-width': [
                        'case',
                        ['==', ['get', 'congestion'], 'low'], 4,
                        ['==', ['get', 'congestion'], 'moderate'], 6,
                        ['==', ['get', 'congestion'], 'heavy'], 8,
                        ['==', ['get', 'congestion'], 'severe'], 10,
                        4
                    ],
                    'line-color': [
                        'case',
                        ['==', ['get', 'congestion'], 'low'],
                        '#22c55e',
                        ['==', ['get', 'congestion'], 'moderate'],
                        '#eab308',
                        ['==', ['get', 'congestion'], 'heavy'],
                        '#ef4444',
                        ['==', ['get', 'congestion'], 'severe'],
                        '#dc2626',
                        '#22c55e'
                    ],
                    'line-opacity': 0.8
                }
            });
        });

    // Add navigation control
    map.addControl(new mapboxgl.NavigationControl());

    // Add fullscreen control
    map.addControl(new mapboxgl.FullscreenControl());

    // Add geolocate control to find user's location
    map.addControl(
        new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true
        })
    );

    console.log('Map loaded with traffic data');
});

// Function to toggle traffic
function toggleTraffic() {
    trafficVisible = !trafficVisible;

    // Toggle traffic layer
    if (map.getLayer('traffic')) {
        map.setLayoutProperty(
            'traffic',
            'visibility',
            trafficVisible ? 'visible' : 'none'
        );
    }

    // Update button text
    const button = document.querySelector('#menu a');
    button.textContent = trafficVisible ? 'Hide Traffic' : 'Show Traffic';
}

// Add click event to get traffic data at clicked location
map.on('click', 'traffic', function(e) {
    const properties = e.features[0].properties;
    const coordinates = e.lngLat;

    // Convert intensity to percentage and traffic level description
    const intensityPercent = (properties.intensity * 100).toFixed(0);
    let trafficLevel = '';
    let colorCode = '';

    if (properties.intensity >= 1.0) {
        trafficLevel = 'Экстремальные пробки (0.95+)';
        colorCode = '#C62828';
    } else if (properties.intensity >= 0.9) {
        trafficLevel = 'Выше 75% (0.91-0.95)';
        colorCode = '#E53935';
    } else if (properties.intensity >= 0.8) {
        trafficLevel = 'Тяжёлые заторы (0.85-0.91)';
        colorCode = '#F44336';
    } else if (properties.intensity >= 0.7) {
        trafficLevel = 'Значительные заторы (0.8-0.85)';
        colorCode = '#FF5722';
    } else if (properties.intensity >= 0.6) {
        trafficLevel = 'Выше медианы (0.74-0.8)';
        colorCode = '#FF9800';
    } else if (properties.intensity >= 0.5) {
        trafficLevel = 'Около медианы (0.7-0.74)';
        colorCode = '#FFC107';
    } else if (properties.intensity >= 0.4) {
        trafficLevel = 'Ниже медианы (0.65-0.7)';
        colorCode = '#FFEB3B';
    } else if (properties.intensity >= 0.3) {
        trafficLevel = 'Выше 25% (0.57-0.65)';
        colorCode = '#CDDC39';
    } else if (properties.intensity >= 0.2) {
        trafficLevel = 'Хорошо (0.5-0.57)';
        colorCode = '#8BC34A';
    } else if (properties.intensity >= 0.1) {
        trafficLevel = 'Очень хорошо (0.4-0.5)';
        colorCode = '#7CB342';
    } else {
        trafficLevel = 'Свободно (<0.4)';
        colorCode = '#00C851';
    }

    new mapboxgl.Popup()
        .setLngLat(coordinates)
        .setHTML(`
            <h3>Квадрат трафика</h3>
            <p><strong>Ячейка:</strong> ${properties.cell_id}</p>
            <p><strong>Загруженность:</strong> ${properties.traffic_load.toFixed(4)}</p>
            <p><strong>Средняя скорость:</strong> ${properties.avg_speed.toFixed(1)} км/ч</p>
            <p><strong>Плотность точек:</strong> ${properties.point_density}</p>
            <p><strong>Цвет трафика:</strong> <span style="color: ${colorCode}; font-size: 18px;">■</span> ${trafficLevel}</p>
            <p><strong>Интенсивность:</strong> ${intensityPercent}% (${properties.intensity.toFixed(4)})</p>
            <p><strong>Координаты:</strong><br>
            Lat: ${coordinates.lat.toFixed(6)}<br>
            Lng: ${coordinates.lng.toFixed(6)}</p>
        `)
        .addTo(map);
});

// Change cursor on hover
map.on('mouseenter', 'traffic', function() {
    map.getCanvas().style.cursor = 'pointer';
});

map.on('mouseleave', 'traffic', function() {
    map.getCanvas().style.cursor = '';
});

// Handle map errors
map.on('error', function(e) {
    console.error('Map error:', e);
    alert('Map loading error. Please check your Mapbox access token.');
});
</script>

</body>
</html>